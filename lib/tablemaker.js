function Table(){this.type=Table.TYPE_UNDEFINED,this.rows=-1,this.width=null,this.height=null,this.cols=-1,this.data=null,this.dataFunction=null,this.container=null,this.table=null,this.contentGrid=null,this.colWidths=null,this.rowHeights=null,this.borderWidth=0,this.alignment=Table.ALIGN_LEFT,this.jquery=null}Table.TYPE_UNDEFINED=0,Table.TYPE_FUNCTION=1,Table.TYPE_DATA=2,Table.TYPE_ROW_COL=4,Table.TYPE_COL_WIDTH=8,Table.TYPE_ROW_HEIGHT=16,Table.TYPE_LOADED=32,Table.TYPE_UNIT_ROW_HEIGHT=64,Table.TYPE_UNIT_COL_WIDTH=128,Table.CELL_TEXT=1,Table.CELL_HTML=2,Table.CELL_ELEMENT=3,Table.CELL_CONTAINED=4,Table.ALIGN_LEFT=0,Table.ALIGN_RIGHT=1,Table.ALIGN_CENTER=2,Table.ALIGN_JUSTIFY=3,Table.ALIGNMENTS=["left","right","center","justify"],Table.prototype.end=function(){if(!(this.type&Table.TYPE_LOADED))throw new Error("The table is not loaded, so it cannot be ended. This may be because the table has been ended already since its last load.");this.type^=Table.TYPE_LOADED,this.container&&(this.container.parentElement.removeChild(this.container),this.container=null,this.table=null);for(var a=this.contentGrid,b=this.rows,c=this.cols,d=0;d<b;d++){for(var f=a[d],g=0,h=0;g<c;h++){var i=f[g],j=i.info;j.r==d?(i.content.end&&i.content.end(),g+=j.width):g++}f=null}this.contentGrid=null},Table.prototype.initWithRowsCols=function(a,b){return this.type|=Table.TYPE_ROW_COL,this.rows=a,this.cols=b,this},Table.prototype.setFunction=function(a){return this.type|=Table.TYPE_FUNCTION,this.dataFunction=a,this.type^=this.type&Table.TYPE_DATA,this.data=null,this},Table.prototype.setData=function(a){return this.type|=Table.TYPE_DATA,this.data=a,this.type^=this.type&Table.TYPE_FUNCTION,this.dataFunction=null,this},Table.prototype.setWidth=function(a){return this.width=a,this},Table.prototype.setColWidth=function(a){return this.type|=Table.TYPE_UNIT_COL_WIDTH,this.type^=this.type&Table.TYPE_COL_WIDTH,this.colWidths=a,this},Table.prototype.setRowHeight=function(a){return this.type|=Table.TYPE_UNIT_ROW_HEIGHT,this.type^=this.type&Table.TYPE_ROW_HEIGHT,this.rowHeights=a,this},Table.prototype.setHeight=function(a){return this.height=a,this},Table.prototype.setBorder=function(a){return this.borderWidth=a,this},Table.prototype.setSize=function(a,b){return this.setWidth(a).setHeight(b)},Table.prototype.setAlignment=function(a){return this.alignment=a||Table.ALIGN_LEFT,this},Table.prototype.getContainer=function(){return this.container?this.container:(this.container=document.createElement("DIV"),this.container)},Table.prototype._getType=function(a){return"object"!=typeof a?Table.CELL_HTML:a.container?Table.CELL_CONTAINED:Table.CELL_ELEMENT},Table.prototype._setCell=function(a,b,c){var e,d=this.contentGrid;if(c.info){e=c.info;var f=e.width,g=e.height;e.r=a,e.c=b,e.type||(e.type=this._getType(c.content))}else e={width:1,height:1,r:a,c:b,type:this._getType(c)},c={info:e,content:c,elem:null};e.alignment||(e.alignment=this.alignment);var h=c.elem=document.createElement("TD");switch(e.type){case Table.CELL_HTML:h.innerHTML=c.content;break;case Table.CELL_ELEMENT:h.appendChild(c.content);break;case Table.CELL_CONTAINED:this.jquery?this.jquery(h).append(c.content.container):h.appendChild(c.content.container);break;case Table.CELL_TEXT:h.textContent=c.content}this.borderWidth&&(h.style.border=this.borderWidth+"px solid"),e.alignment!=this.alignment&&(h.style.textAlign=Table.ALIGNMENTS[e.alignment]);for(var f=e.width,g=e.height,i=0;i<g;i++)for(var j=0;j<f;j++)d[a+i][b+j]=c;return 1!=f&&h.setAttribute("colspan",f),1!=g&&h.setAttribute("rowspan",g),f},Table.prototype.contentToTable=function(a,b,c,d){a||(a=0),b||(b=0),c||(c=this.rows),d||(d=this.cols);var e=this.type;if(e&Table.TYPE_LOADED){for(var f=document.createElement("TABLE"),g=this.contentGrid,h=c,i=d,j=0,k=0;k<a;)k+=g[j][0].info.height,j++;for(var l=a;l<h;l++){for(var m=g[l],n=document.createElement("TR"),o=0;o<b;)o+=m[o].info.width;for(var p=o;p<i;o++){var q=m[p].info;q.r==l?(0==l&&e&Table.TYPE_UNIT_COL_WIDTH&&(m[p].elem.style.width=this.colWidths*q.width),0==p&&e&Table.TYPE_UNIT_ROW_HEIGHT&&(m[p].elem.style.height=this.rowHeights*q.height),n.appendChild(m[p].elem),p+=q.width):p++}f.appendChild(n)}return null!==this.width&&(f.style.width=this.width),null!==this.height&&(f.style.height=this.height),f.style.textAlign=Table.ALIGNMENTS[this.alignment],f.style.borderCollapse="collapse",f}return null},Table.prototype.refreshCell=function(a,b){var c=Table.TYPE_FUNCTION|Table.TYPE_LOADED;if((this.type&c)==c){var d=this.contentGrid,e=d[a],f=e[b];if(f.info.r==a&&f.info.c==b){for(var g=this.table,h=g.children[a],i=0,j=0;i<b;)i+=e[i].info.width,j++;return this._setCell(a,b,this.dataFunction(a,b)),h.insertBefore(e[b].elem,h.children[j]),h.removeChild(h.children[j+1]),!0}return!1}},Table.prototype.is=function(a){return!!(a&this.type||a==this.type)},Table.prototype.addRow=function(a,b){a||(a=1);var c=this.rows;this.rows+=a;var d=Table.TYPE_LOADED|Table.TYPE_FUNCTION;if((this.type&d)==d){var e=this.contentGrid;void 0===b&&(b=this.rows-a);var f=new Array(a+2);f[0]=b,f[1]=0;for(var g=2;g<a+2;g++)f[g]=new Array(this.cols);this.contentGrid.splice.apply(this.contentGrid,f);for(var h=b+a;h<this.rows;h++)for(var i=e[h],j=0;j<this.cols;){var k=i[j];if(k){var l=k.info.r,m=e[l+a+k.info.height-1];l==h-a&&m&&m[j]==k&&(k.info.r+=a),j+=k.info.width}else j++}var n=b-1;if(n!=-1)for(var i=e[n],j=0;j<this.cols;j++){var k=i[j];if(k.info.height-b+k.info.r>0){for(var h=0;h<a;h++)e[h+b][j]=k;0==j&&this.type&Table.TYPE_UNIT_ROW_HEIGHT&&(k.elem.style.height=this.rowHeights*(k.info.height+a)),k.info.c==j&&(k.info.height+=a,k.elem.setAttribute("rowspan",k.info.height))}}for(var g=0;g<a;g++)for(var h=g+b,i=e[h],j=0,o=0;j<this.cols;)i[j]?j++:(j+=this._setCell(h,j,this.dataFunction(h,o)),o++);var p=this.contentToTable(b,0,b+a);if(0==b){var q=this.table.children[0];if(q)for(var g=0;g<q.children.length;g++)q.children[g].style.width=""}if(b==c)for(;p.children.length>0;)this.table.appendChild(p.children[0]);else for(var r=this.table.children[b];p.children.length>0;)this.table.insertBefore(p.children[0],r)}},Table.prototype.addCol=function(a,b){a||(a=1);var c=this.cols;this.cols+=a;var d=Table.TYPE_LOADED|Table.TYPE_FUNCTION;if((this.type&d)==d){var e=this.contentGrid;void 0===b&&(b=this.cols-a);for(var f,g=0;g<this.rows;g++)f=new Array(a+2),f[0]=b,f[1]=0,e[g].splice.apply(e[g],f);f=null;for(var g=0;g<this.rows;g++)for(var h=e[g],i=b+a;i<this.cols;){var j=h[i];if(j){var k=j.info.width,l=j.info.c;l==i-a&&h[l+a+k-1]==j&&(j.info.c+=a),i+=k}else i++}var m=b-1;if(m!=-1)for(var g=0;g<this.rows;g++){var h=e[g],j=h[m];if(j.info.width-b+j.info.c>0){for(var i=0;i<a;i++)h[b+i]=j;0==g&&this.type&Table.TYPE_UNIT_ROW_HEIGHT&&(j.elem.style.width=this.colWidths*(j.info.width+a)),j.info.r==g&&(j.info.width+=a,j.elem.setAttribute("colspan",j.info.width))}}for(var n=b+a,g=0;g<this.rows;g++){for(var h=e[g],o=0;o<b;)o+=h[o].info.width;for(var i=o;i<n;)h[i]?i++:(i+=this._setCell(g,i,this.dataFunction(g,o)),o++)}var p=this.contentToTable(0,b,0,n);if(0==b)for(var q=0;q<this.table.children.length;q++){var r=this.table.children[q],j=r.children[0];j&&(j.style.height="")}if(b==c)for(var g=0;g<this.rows;g++)for(var r=p.children[g],s=this.table.children[g];r.children.length>0;)s.appendChild(r.children[0]);else for(var g=0;g<this.rows;g++)for(var r=p.children[g],s=this.table.children[g],t=s.children[b];r.children.length>0;)s.insertBefore(r.children[0],t)}},Table.prototype.removeRow=function(a,b){a||(a=1);var c=this.rows;this.rows-=a;var d=Table.TYPE_LOADED|Table.TYPE_FUNCTION;if((this.type&d)==d){var e=this.contentGrid;void 0===b&&(b=this.rows-a-1);for(var g=b,h=b+a;g<h;g++)for(var i=0;i<this.cols;){var j=e[g][i];if(j){var k=j.info.r,l=j.info.c,m=j.info.width,n=j.info.height,o=k+n-g;if(k==g)if(k+n<h);else{if(k+n>h){for(var p=h-k,q=h-p;q<h;q++)for(var r=l;r<l+m;)e[q][r]=null;n=j.info.height-=p,j.elem.setAttribute("rowspan",n)}for(var q=h;q<c;){var s=e[q][i];s.info.r=q-a,q+=s.info.height}}else{var p=g-k;o>a&&(o=a);for(var q=g;q<g+o;q++)for(var r=l;r<l+m;)e[q][r]=null;n=j.info.height-=p,j.elem.setAttribute("rowspan",n)}console.log(g,i,m),i+=m}else console.log(g,i,null),i++}this.contentGrid.splice(b,a);for(var t=this.table;a--;)t.removeChild(t.children[b])}},Table.prototype.removeCol=function(a,b){a||(a=1);var c=this.cols;this.cols-=a;var d=Table.TYPE_LOADED|Table.TYPE_FUNCTION;if((this.type&d)==d){var e=this.contentGrid;void 0===b&&(b=this.cols);for(var f=this.table,g=f.children,h=0;h<g.length;h++)for(var i=a,j=b,k=g[h],l=b;i>0;){var m=e[h][j];if(m)if(m.info.c==j){if(i-=m.info.width,i>=0)k.removeChild(m.elem);else{var n=m.info.width,o=m.info.height,p=m.info.r,q=m.info.width=-i;n+=i,m.elem.setAttribute("colspan",q),this.type&Table.TYPE_UNIT_COL_WIDTH&&(m.elem.style.width=this.colWidths*q);for(var r=0;r<o;r++)for(var s=0;s<n;s++)e[p+r][j+s]=null}if(i<=0)for(0==i&&j++;j<c;)m=e[h][j],m.info.r==h?(console.log("setting cc",l,m.elem),m.info.c=l,l+=m.info.width,j+=m.info.width):(l++,j++);j+=m.info.width}else{var t=j;l=m.info.c;var n=m.info.width,o=m.info.height,p=m.info.r;i-=l-j+n,j=l+n;var q=m.info.width=t-l;if(n-q>a){n-=a;for(var r=0;r<o;r++)for(var s=q;s<q+a;s++)e[p+r][l+s]=null;q=m.info.width=n}else for(var r=0;r<o;r++)for(var s=q;s<n;s++)e[p+r][l+s]=null;m.elem.setAttribute("colspan",q),this.type&Table.TYPE_UNIT_COL_WIDTH&&(m.elem.style.width=this.colWidths*q),l++}else j++,i--}for(var h=0;h<this.rows;h++)e[h].splice(b,a)}},Table.prototype.load=function(){var a=this.type,b=!0;if(a&Table.TYPE_ROW_COL){this.contentGrid=new Array(this.rows);for(var c=0;c<this.rows;c++)this.contentGrid[c]=new Array(this.cols);if(a&Table.TYPE_FUNCTION)for(var d=this.contentGrid,e=0;e<this.rows;e++)for(var f=d[e],g=0,h=0;g<this.cols;)f[g]?g++:(g+=this._setCell(e,g,this.dataFunction(e,h)),h++);else if(a&Table.TYPE_DATA)for(var d=this.contentGrid,e=0;e<this.rows;e++)for(var f=d[e],g=0,h=0;g<this.cols;)f[g]?g++:(g+=this._setCell(e,g,this.data[e][h]),h++);else b=!1}else b=!1;b?this.type|=Table.TYPE_LOADED:this.type^=this.type&Table.TYPE_LOADED;var i=this.getContainer();return i.innerHTML="",this.table=this.contentToTable(),i.appendChild(this.table),i};